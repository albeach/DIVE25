_format_version: "3.0"
_transform: true

services:
  - name: dive25-api
    url: http://api:6969
    routes:
      - name: api-route
        paths:
          - /api
        strip_path: true
    plugins:
      # Authentication
      - name: oidc
        config:
          client_id: dive25-api
          client_secret: ${KEYCLOAK_CLIENT_SECRET}
          discovery: http://keycloak:8080/realms/dive25/.well-known/openid-configuration
          introspection_endpoint: http://keycloak:8080/realms/dive25/protocol/openid-connect/token/introspect
          bearer_only: "yes"
          realm: dive25
          scope: openid profile email
          verify_claims: true
          claims_to_verify:
            - countryOfAffiliation
            - clearance_level
            - coi_access

      # NATO-specific Security Headers
      - name: response-transformer
        config:
          add:
            headers:
              - "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
              - "X-Content-Type-Options: nosniff"
              - "X-Frame-Options: DENY"
              - "Content-Security-Policy: default-src 'self'; frame-ancestors 'none'"
              - "X-XSS-Protection: 1; mode=block"
              - "X-NATO-Federation-ID: ${FEDERATION_ID}"

      # Rate Limiting by Partner Type
      - name: rate-limiting
        config:
          minute: 600
          hour: 36000
          policy: local
          header_name: X-Federation-Partner
          limit_by: header
          fault_tolerant: true
          hide_client_headers: false

      # IP Restriction (allow only NATO network ranges)
      - name: ip-restriction
        config:
          allow:
            - 10.0.0.0/8     # NATO Internal
            - 192.168.0.0/16 # Partner VPNs
          message: "Access denied: IP not in NATO federation network"

      # Request Size Limiting
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

      # Correlation ID for NATO Audit
      - name: correlation-id
        config:
          header_name: X-NATO-Correlation-ID
          generator: uuid#counter
          echo_downstream: true

  - name: keycloak
    url: http://keycloak:8080
    routes:
      - name: keycloak-route
        paths:
          - /auth
    plugins:
      # Basic Security Headers
      - name: response-transformer
        config:
          add:
            headers:
              - "Strict-Transport-Security: max-age=31536000"
              - "X-Content-Type-Options: nosniff"
              - "X-Frame-Options: DENY"

      # Rate Limiting for Auth Endpoints
      - name: rate-limiting
        config:
          minute: 30
          hour: 1000
          policy: local
          fault_tolerant: true

      # Bot Detection
      - name: bot-detection
        config:
          allow:
            - "curl"
            - "PostmanRuntime"
          deny:
            - "BadBot"
            - "*scraper*" 